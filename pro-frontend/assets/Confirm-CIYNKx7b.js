import{j as e}from"./ui-vendor-DjtdC3iZ.js";import{u as ze,c as ke,r as t}from"./react-vendor-DWrzsp0o.js";import{u as Re}from"./booking-CI0fwwsN.js";import{c as _e,d as U,B as N}from"./index-CX6e3e6v.js";import{I as V}from"./input-BYXIM_YD.js";import{L as w}from"./label-JnwPont5.js";import{T as Le}from"./textarea-BOvA95EP.js";import{a as C,A as Ie}from"./api-PPFfqhN_.js";import{u as $}from"./index-CQSUpRmg.js";import{B as xe}from"./BookingLayout-DM7n9nHe.js";import{C as ue}from"./calendar-7ygCif2F.js";import{S as Se}from"./scissors-d8NSnT0-.js";import{U as Pe,C as pe}from"./user-9509D_2P.js";import{S as H}from"./skeleton-BQs0x_V-.js";import"./index-Dbmg-Ekv.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=_e("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]),Be=o=>typeof o=="number"?o.toLocaleString("es-ES",{style:"currency",currency:"EUR",maximumFractionDigits:0}):"",Me=o=>new Date(o).toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),De=o=>new Date(o).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}),Fe=o=>`${Me(o)}, ${De(o)}h`,Te=/^[^\s@]+@[^\s@]+\.[^\s@]+$/i,es=()=>{const o=ze(),c=ke(),{serviceId:m,serviceName:E,professionalId:p,professionalName:z,slotStart:x,reset:k,setService:G,setProfessional:R,setSlot:_,customerName:L,customerPhone:I,customerEmail:S,notes:P,setCustomerName:J,setCustomerPhone:X,setCustomerEmail:K,setNotes:Q}=Re(),[B,W]=t.useState(!1),[Y,Z]=t.useState(null),[b,ee]=t.useState(null),[se,ae]=t.useState(null),[re,fe]=t.useState([]),[M,ve]=t.useState([]),[be,Ne]=t.useState(!1),[n,te]=t.useState({}),D=t.useMemo(()=>L.trim(),[L]),g=t.useMemo(()=>I.trim(),[I]),ge=t.useMemo(()=>g.replace(/\D+/g,""),[g]),h=t.useMemo(()=>(S??"").trim(),[S]),j=t.useMemo(()=>(P??"").trim(),[P]),F=D.length>=2,T=ge.length>=6,q=h===""||Te.test(h),oe=F&&T&&q,f=t.useMemo(()=>new URLSearchParams(c.search),[c.search]),A=f.get("service_name")||void 0,O=f.get("pro_name")||void 0,r=t.useMemo(()=>c.state??null,[c.state]);t.useEffect(()=>{let s=!0;return(async()=>{try{const i=await C.getServices();s&&fe(i)}catch{}try{const i=await C.getProfessionals();s&&ve(i)}catch{}s&&Ne(!0)})(),()=>{s=!1}},[]);const d=t.useMemo(()=>re.find(s=>s.id===m),[re,m]),u=t.useMemo(()=>M.find(s=>s.id===p),[M,p]),ie=(d==null?void 0:d.name)||A||(r==null?void 0:r.serviceName)||E||m,je=(u==null?void 0:u.name)||O||(r==null?void 0:r.professionalName)||z||p||"Cualquiera disponible",ne=!be;t.useEffect(()=>{if(m&&x)return;const s=f.get("service")||(r==null?void 0:r.serviceId)||void 0,i=f.get("start")||(r==null?void 0:r.slotStart)||void 0,a=f.get("pro"),l=a!==null?a:(r==null?void 0:r.professionalId)??null,y=O||(r==null?void 0:r.professionalName)||(u==null?void 0:u.name)||z||null;s&&G(s,A??(r==null?void 0:r.serviceName)??E),i&&_(i),l!==null&&R(l||null,y)},[m,E,z,u,x,f,G,_,R,A,r,O]);const ye=s=>{if(s instanceof Ie){const i=s.status;let a=s.detail||s.message;if(!a&&s.rawBody)try{const l=JSON.parse(s.rawBody);l&&typeof l=="object"&&l.detail&&(a=String(l.detail))}catch{a=s.rawBody}if(a){if(/hora ocupada/i.test(a)||/inicio no está disponible/i.test(a))return"Ese horario ya no está disponible. Elige otro hueco.";if(/no ofrece ese servicio/i.test(a))return"Ese profesional no ofrece ese servicio. Prueba con otra persona.";if(/service_id no existe/i.test(a))return"El servicio seleccionado ya no existe.";if(/professional_id no existe/i.test(a))return"El profesional seleccionado ya no existe.";if(/tel[eé]fono.*contacto/i.test(a))return"Necesitamos un teléfono de contacto para confirmar la cita."}switch(i){case 400:return a||"No pudimos crear la reserva. Revisa los datos e inténtalo de nuevo.";case 401:return"Necesitas iniciar sesión o proporcionar la clave correcta para crear reservas.";case 403:return"No tienes permisos para realizar esta acción.";case 404:return a||"No encontramos la información necesaria. Comprueba que la cita sigue disponible.";case 409:return"Ese horario acaba de ocuparse. Elige otro hueco disponible.";case 422:return a||"Los datos enviados no son válidos. Revisa la información del servicio y horario.";default:return i>=500?"El servidor tuvo un problema inesperado. Inténtalo de nuevo en unos minutos.":a||"No pudimos crear la reserva. Inténtalo de nuevo."}}return s instanceof Error?s.message:"Error creando la reserva"},we=async()=>{Z(null),ee(null),ae(null);const s={};if(F||(s.name="Introduce un nombre con al menos 2 caracteres."),T||(s.phone="Introduce un teléfono de contacto válido."),q||(s.email="Introduce un correo electrónico válido o deja el campo vacío."),Object.keys(s).length>0){te(s),$.error("Completa los datos de contacto para confirmar la reserva.");return}te({}),J(D),X(g),K(h||null),Q(j||null),W(!0);try{const i={service_id:m,start:x,customer_name:D,customer_phone:g,...h?{customer_email:h}:{},...j?{notes:j}:{}};let a=null;if(p)a=await C.createReservation({...i,professional_id:p});else{const l=M.filter(v=>!v.services||v.services.includes(m));if(l.length===0)throw new Error("No hay profesionales disponibles para este servicio");let y=!1,de="";for(const v of l)try{a=await C.createReservation({...i,professional_id:v.id}),R(v.id,v.name),x&&_(x),y=!0;break}catch(me){de=me instanceof Error?me.message:"Error desconocido"}if(!y)throw new Error(`No fue posible crear la reserva: ${de}`)}a&&(ee(a.message),ae(a.reservation_id)),$.success("Reserva confirmada")}catch(i){const a=ye(i);Z(a),$.error(a)}finally{W(!1)}},Ce=t.useCallback(()=>{k(),o("/")},[o,k]),Ee=t.useCallback(()=>{o("/book/date",{state:U(c)})},[o,c]);if(t.useEffect(()=>{if(typeof document>"u")return;const s=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=s}},[]),!m||!x)return e.jsx(xe,{title:"Confirmar reserva",subtitle:"Revisa los detalles antes de confirmar",children:e.jsxs("div",{className:"mx-auto max-w-2xl rounded-2xl border border-amber-400/30 bg-amber-400/10 p-10 text-center shadow-soft",children:[e.jsx("div",{className:"mx-auto mb-6 grid h-20 w-20 place-items-center rounded-full border border-amber-400/40 bg-amber-400/15",children:e.jsx(ue,{className:"h-10 w-10 text-amber-300"})}),e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Faltan datos de tu reserva"}),e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Completa los pasos anteriores para continuar."}),e.jsx(N,{variant:"outline",className:"mt-6",onClick:()=>o("/book/service",{state:U(c)}),children:"Ir a seleccionar servicio"})]})});const le=B||!oe,ce=!oe&&!b?"Completa los campos obligatorios para habilitar la confirmación de la reserva.":null;return e.jsx(xe,{title:"Confirmar reserva",subtitle:"Revisa los detalles antes de confirmar tu cita",summary:`Servicio seleccionado: ${ie}`,children:e.jsx("div",{className:"mx-auto w-full max-w-[960px]",children:e.jsx("div",{className:"relative rounded-3xl border border-zinc-800/70 bg-zinc-900/85 shadow-[0_40px_120px_-60px_rgba(0,0,0,0.8)]",children:e.jsxs("div",{className:"px-5 pb-8 pt-8 md:px-8 md:pb-10 md:pt-10",children:[e.jsxs("div",{className:"space-y-2 text-center",children:[e.jsx("h3",{className:"text-xl font-semibold text-white md:text-2xl",children:"Revisa y confirma tu reserva"}),e.jsx("p",{className:"text-sm text-zinc-400",children:"Comprueba los detalles y completa tus datos de contacto para finalizar."})]}),e.jsxs("div",{className:"mt-8 grid gap-8 lg:grid-cols-[1.65fr,1fr]",children:[e.jsxs("section",{className:"space-y-6 rounded-2xl border border-zinc-800/80 bg-zinc-900/65 p-6",children:[e.jsxs("header",{className:"space-y-1 text-left",children:[e.jsx("h3",{className:"text-lg font-semibold text-white md:text-xl",children:"Datos de contacto"}),e.jsx("p",{className:"text-sm text-zinc-400",children:"Necesitamos un nombre y un teléfono por si debemos avisarte de cambios."})]}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(w,{htmlFor:"customer-name",className:"text-sm font-medium text-zinc-200",children:["Nombre completo ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx(V,{id:"customer-name",value:L,onChange:s=>J(s.target.value),autoComplete:"name","aria-invalid":!F||!!n.name,"aria-describedby":n.name?"customer-name-error":void 0,required:!0}),n.name&&e.jsx("p",{id:"customer-name-error",className:"text-xs text-red-300",children:n.name})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(w,{htmlFor:"customer-phone",className:"text-sm font-medium text-zinc-200",children:["Teléfono ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx(V,{id:"customer-phone",type:"tel",inputMode:"tel",autoComplete:"tel",placeholder:"Ej. +34 600 123 456",value:I,onChange:s=>X(s.target.value),"aria-invalid":!T||!!n.phone,"aria-describedby":n.phone?"customer-phone-error":void 0,required:!0}),n.phone&&e.jsx("p",{id:"customer-phone-error",className:"text-xs text-red-300",children:n.phone})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(w,{htmlFor:"customer-email",className:"text-sm font-medium text-zinc-200",children:"Correo electrónico"}),e.jsx(V,{id:"customer-email",type:"email",autoComplete:"email",value:S??"",onChange:s=>K(s.target.value?s.target.value:null),"aria-invalid":!q||!!n.email,"aria-describedby":n.email?"customer-email-error":"customer-email-helper",placeholder:"Opcional"}),n.email?e.jsx("p",{id:"customer-email-error",className:"text-xs text-red-300",children:n.email}):e.jsx("p",{id:"customer-email-helper",className:"text-xs text-zinc-500",children:"Te avisaremos también por email si lo facilitas."})]}),e.jsxs("div",{className:"space-y-1.5 md:col-span-2",children:[e.jsx(w,{htmlFor:"customer-notes",className:"text-sm font-medium text-zinc-200",children:"Notas para la barbería"}),e.jsx(Le,{id:"customer-notes",rows:3,value:P??"",onChange:s=>Q(s.target.value?s.target.value:null),placeholder:"Opcional: ¿algo que debamos saber?"}),e.jsx("p",{className:"text-xs text-zinc-500",children:"Ejemplo: alergias, preferencias, si vienes acompañado, etc."})]})]})]}),e.jsxs("aside",{className:"flex flex-col gap-5 rounded-2xl border border-emerald-500/25 bg-zinc-900/70 p-6",children:[e.jsxs("div",{className:"space-y-1 text-left",children:[e.jsx("h4",{className:"text-sm font-semibold uppercase tracking-wide text-emerald-200",children:"Resumen de la cita"}),e.jsx("p",{className:"text-xs text-emerald-100/70",children:"Confirma que todos los detalles son correctos antes de enviar."})]}),ne?e.jsx("div",{className:"space-y-4",role:"status","aria-live":"polite",children:Array.from({length:3}).map((s,i)=>e.jsxs("div",{className:"flex items-center gap-4 rounded-xl border border-zinc-800/70 bg-zinc-900/80 p-4",children:[e.jsx(H,{className:"h-10 w-10 rounded-xl"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(H,{className:"h-4 w-28 rounded"}),e.jsx(H,{className:"h-3 w-24 rounded"})]})]},i))}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-4 rounded-xl border border-emerald-500/25 bg-emerald-500/5 p-4",children:[e.jsx("div",{className:"grid h-11 w-11 place-items-center rounded-xl bg-emerald-500/15 text-emerald-200",children:e.jsx(Se,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("p",{className:"text-xs font-medium uppercase tracking-wide text-emerald-200/80",children:"Servicio"}),e.jsx("p",{className:"text-base font-semibold text-white",children:ie}),e.jsxs("p",{className:"text-sm text-emerald-100/75",children:[d==null?void 0:d.duration_min," min · ",Be(d==null?void 0:d.price_eur)]})]})]}),e.jsxs("div",{className:"flex items-start gap-4 rounded-xl border border-zinc-800/70 bg-zinc-900/80 p-4",children:[e.jsx("div",{className:"grid h-11 w-11 place-items-center rounded-xl bg-zinc-800/80 text-emerald-200",children:e.jsx(Pe,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("p",{className:"text-xs font-medium uppercase tracking-wide text-white/50",children:"Profesional"}),e.jsx("p",{className:"text-base font-semibold text-white",children:je})]})]}),e.jsxs("div",{className:"flex items-start gap-4 rounded-xl border border-zinc-800/70 bg-zinc-900/80 p-4",children:[e.jsx("div",{className:"grid h-11 w-11 place-items-center rounded-xl bg-zinc-800/80 text-emerald-200",children:e.jsx(ue,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("p",{className:"text-xs font-medium uppercase tracking-wide text-white/50",children:"Fecha y hora"}),e.jsx("p",{className:"text-base font-semibold text-white",children:Fe(x)})]})]})]}),!ne&&e.jsxs("div",{className:"rounded-xl border border-emerald-500/25 bg-emerald-500/5 px-4 py-3 text-xs text-emerald-200",children:[e.jsx("p",{className:"font-medium uppercase tracking-wide",children:"Recuerda"}),e.jsx("p",{className:"mt-1 text-emerald-100/80",children:"Podrás modificar o cancelar tu cita respondiendo al correo de confirmación."})]})]})]}),Y&&e.jsx("div",{className:"mt-6 rounded-xl border border-red-500/30 bg-red-500/10 p-4",role:"alert",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(pe,{className:"h-5 w-5 text-red-300","aria-hidden":"true"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold text-red-200",children:"No se pudo confirmar"}),e.jsx("p",{className:"text-sm text-red-100",children:Y})]})]})}),b&&e.jsx("div",{className:"mt-6 rounded-xl border border-emerald-500/30 bg-emerald-500/10 p-4",role:"status","aria-live":"polite",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(pe,{className:"h-5 w-5 text-emerald-400","aria-hidden":"true"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold text-emerald-200",children:"¡Reserva creada!"}),e.jsx("p",{className:"break-all text-sm text-emerald-100",children:b}),se&&e.jsxs("p",{className:"text-xs text-emerald-200/80","data-testid":"reservation-id",children:["ID: ",se]})]})]})}),e.jsxs("div",{className:"sticky bottom-0 mt-8 -mx-5 flex flex-col gap-4 border-t border-zinc-800/70 bg-zinc-900/85 px-5 py-5 backdrop-blur-sm md:-mx-8 md:flex-row md:items-center md:justify-between md:px-8 rounded-b-3xl",children:[ce&&!b&&e.jsx("p",{className:"text-xs text-zinc-400 md:max-w-sm",role:"status","aria-live":"polite",children:ce}),e.jsx("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-end",children:b?e.jsxs(e.Fragment,{children:[e.jsx(N,{onClick:()=>{k(),o("/book/service",{state:U(c)})},className:"h-10 rounded-xl border border-emerald-500/40 bg-emerald-500/10 px-5 text-emerald-200 transition hover:bg-emerald-500/20",children:"Crear otra reserva"}),e.jsxs(N,{variant:"outline",onClick:Ce,className:"h-10 rounded-xl border-zinc-700 bg-zinc-900 px-5 text-zinc-100 transition hover:border-emerald-400/60",children:[e.jsx(he,{className:"mr-2 h-4 w-4","aria-hidden":"true"})," Volver al inicio"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(N,{variant:"outline",onClick:Ee,disabled:B,className:"h-10 rounded-xl border-zinc-700 bg-zinc-900 px-5 text-zinc-100 transition hover:border-emerald-400/60 disabled:opacity-40",children:[e.jsx(he,{className:"mr-2 h-4 w-4","aria-hidden":"true"})," Volver"]}),e.jsx(N,{onClick:we,disabled:le,"aria-disabled":le,className:"h-10 rounded-xl border border-emerald-500/40 bg-emerald-500/15 px-5 text-emerald-200 shadow-soft transition hover:bg-emerald-500/25 disabled:pointer-events-none disabled:opacity-40",children:B?"Confirmando…":"Confirmar reserva"})]})})]})]})})})})};export{es as default};
